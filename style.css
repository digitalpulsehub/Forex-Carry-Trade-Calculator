const API_BASE = 'https://api.frankfurter.dev/v1';
let refreshTimer = 30;
let countdownInterval;

// Core App Logic
const App = {
    async init() {
        this.updateClock();
        await this.loadCurrencies();
        this.startAutoRefresh();
        this.addEventListeners();
        this.performUpdate();
    },

    updateClock() {
        const now = new Date();
        document.getElementById('current-date').innerText = now.toLocaleString('en-US', { 
            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit'
        });
        setTimeout(() => this.updateClock(), 1000);
    },

    async loadCurrencies() {
        const res = await fetch(`${API_BASE}/currencies`);
        const data = await res.json();
        const selects = [document.getElementById('base-currency'), document.getElementById('quote-currency')];
        
        selects.forEach((s, i) => {
            Object.keys(data).forEach(code => {
                let opt = new Option(code, code);
                s.add(opt);
            });
            s.value = i === 0 ? 'USD' : 'JPY';
        });
    },

    async performUpdate() {
        const base = document.getElementById('base-currency').value;
        const quote = document.getElementById('quote-currency').value;
        const size = parseFloat(document.getElementById('position-size').value);
        const lRate = parseFloat(document.getElementById('long-rate').value) / 100;
        const sRate = parseFloat(document.getElementById('short-rate').value) / 100;

        try {
            const res = await fetch(`${API_BASE}/latest?base=${base}&symbols=${quote}`);
            const data = await res.json();
            const rate = data.rates[quote];

            // Update UI
            document.getElementById('live-price').innerText = rate.toFixed(4);
            document.getElementById('price-date').innerText = `ECB Rate Date: ${data.date}`;

            // Math: Profit = Size * (Interest Diff) 
            // We use the base currency (the one you own) as the result unit
            const annual = size * (lRate - sRate);
            const monthly = annual / 12;
            const daily = annual / 365;

            document.getElementById('daily-res').innerText = `${daily.toFixed(2)} ${base}`;
            document.getElementById('monthly-res').innerText = `${monthly.toFixed(2)} ${base}`;
            document.getElementById('annual-res').innerText = `${annual.toFixed(2)} ${base}`;

            // Update Chart (from chart.js)
            updateChartProjections(daily);

        } catch (e) {
            console.error("Fetch error:", e);
        }
    },

    startAutoRefresh() {
        clearInterval(countdownInterval);
        refreshTimer = 30;
        countdownInterval = setInterval(() => {
            refreshTimer--;
            document.getElementById('timer').innerText = `${refreshTimer}s`;
            if (refreshTimer <= 0) {
                this.performUpdate();
                refreshTimer = 30;
            }
        }, 1000);
    },

    addEventListeners() {
        document.getElementById('calculate-btn').onclick = () => this.performUpdate();
        document.getElementById('refresh-btn').onclick = () => {
            this.performUpdate();
            this.startAutoRefresh();
        };
        // F5 Handler
        window.onkeydown = (e) => {
            if (e.key === 'F5') {
                e.preventDefault();
                this.performUpdate();
                this.startAutoRefresh();
            }
        };
    }
};

App.init();
